# Phase 3 手順書作成補佐 - テストガイド

## 🎯 Phase 3 で何が変わったか

### 従来の問題点

❌ **間違ったアプローチ（以前の実装）**:
```
ユーザー: "DNS設定変更の手順書を作成したい"
↓
システム: "DNS設定変更 手順書 作成" で検索
↓
結果: ノイズだらけで何も見つからない
```

### 正しいRAG実装（現在の実装）

✅ **正しいアプローチ**:
```
ユーザー: "DNS設定変更の手順書を作成したい"
↓
[Step 1] LLMがクエリを分析
  → keywords: "DNS設定変更" (「手順書」「作成」は除外)
  → time_filter: null
  → server_filter: null

↓
[Step 2] キーワードをベクトル化
  "DNS設定変更" → OpenAI Embedding API → [0.15, -0.42, 0.81, ...]

↓
[Step 3] Qdrantでベクトル検索
  vector → search → チケット10件取得

↓
[Step 4] LLMがチケットの内容を読む（タイトルだけじゃない！）
  チケット#1234の説明:
  "DNSサーバーを10.1.1.1から10.1.1.2に変更。
   ゾーンファイルの編集が必要。named.confも更新..."

  → LLM: "ゾーンファイルの編集方法も調べるべき"
  → LLM: "named.conf の設定も調べるべき"

↓
[Step 5] 追加検索
  "ゾーンファイル" → vectorize → search
  "named.conf 設定" → vectorize → search

↓
[Step 6] 統合・推奨事項の生成
  すべてのチケットを統合し、自然な文章で推奨事項を生成
```

## 📋 テスト前の準備

### 1. セットアップ検証

```bash
# 検証スクリプトを実行
./verify_setup.sh
```

すべての項目が ✓ になることを確認してください。

### 2. 必須の環境変数

`.env` ファイルに以下が設定されていることを確認:

```bash
# OpenAI API
OPENAI_API_KEY=sk-...

# Redmine
REDMINE_URL=http://your-redmine-server.com
REDMINE_API_KEY=...

# Phase 3 有効化
PROCEDURE_ASSIST_ENABLED=true
```

### 3. Qdrantのデータ確認

```bash
# コレクションの存在確認
curl http://localhost:6333/collections/maintenance_tickets

# vectors_count が 0 の場合、インデックスを実行
source venv/bin/activate
python scripts/index_redmine_tickets.py
```

## 🚀 システムの起動

```bash
# 停止中の場合
./start.sh

# 起動確認
# - Web UI: http://localhost:8501
# - API: http://localhost:8000/docs
```

## 🧪 テストケース

### テストケース 1: 基本的な検索

**入力**:
```
作業内容: DNS設定変更の手順書を作成したい
```

**期待される動作**:
1. 検索プロセス（デバッグ情報）で以下が確認できる:
   - 初回検索クエリ: "DNS設定変更" （「手順書」「作成」は含まれない）
   - LLMが提案した追加検索: "ゾーンファイル", "named.conf" など
2. 分析結果が自然な文章で表示される
3. 関連チケットが重要度順に表示される

**確認ポイント**:
- [ ] ノイズワード（手順書、作成、作りたい）が検索クエリに含まれていない
- [ ] LLMが追加の検索を提案している
- [ ] 分析結果が「ChatGPT風」の自然な文章
- [ ] チケットの重要度が適切に評価されている

### テストケース 2: コンテキスト付き検索

**入力**:
```
作業内容: ファイアウォール設定変更
追加コンテキスト: 新規サーバーへの展開で、既存FWも並行稼働中
```

**期待される動作**:
1. LLMがコンテキストを考慮して分析
2. 「並行稼働」「新規サーバー」などの観点も含めて検索
3. 関連する注意事項が抽出される

**確認ポイント**:
- [ ] コンテキストが分析に反映されている
- [ ] 「並行稼働時の注意点」などが推奨事項に含まれる

### テストケース 3: 時間フィルタ

**入力**:
```
作業内容: 先月のディスク容量アラートの対処方法
```

**期待される動作**:
1. LLMが「先月」を時間フィルタとして抽出
2. 該当期間のチケットを優先的に検索

**確認ポイント**:
- [ ] 検索プロセスで時間フィルタが表示される
- [ ] 該当期間のチケットが表示される

### テストケース 4: ゼロヒット時の動作

**入力**:
```
作業内容: 存在しない作業XYZABC
```

**期待される動作**:
1. 検索結果が0件でも、適切なフォールバックメッセージを表示
2. 「該当するチケットが見つかりませんでした」

**確認ポイント**:
- [ ] エラーにならない
- [ ] フォールバックメッセージが表示される

## 🔍 デバッグ情報の見方

### 検索プロセス（UI）

Web UI の「🔍 検索プロセス（デバッグ情報）」を展開すると:

```
初回検索クエリ: DNS設定変更
初回検索結果: 5件
LLMが提案した追加検索:
  - ゾーンファイル
  - named.conf 設定
最終結果: 12件
```

### API ログ

```bash
tail -f logs/api.log
```

以下のログが出力される:

```
=== 手順書作成補佐（正しいRAG） ===
Query: DNS設定変更の手順書を作成したい

Step 1: クエリ分析
Keywords extracted: DNS設定変更
Time filter: None
Server filter: None

Step 2: 初回検索
Query vector: [0.15, -0.42, ...]
Found 5 tickets

Step 3: チケット内容の分析とギャップ特定
Analyzing ticket content...
Additional searches needed: ['ゾーンファイル', 'named.conf 設定']

Step 4: 追加検索
  - ゾーンファイル: 3件
  - named.conf 設定: 4件

Step 5: 統合
Total unique tickets: 12

Step 6: 詳細分析
Analyzing 12 tickets...

Step 7: 推奨事項生成
Generated recommendations.
```

## 📊 品質確認チェックリスト

### 検索の品質

- [ ] ノイズワード（手順書、作成、等）が検索クエリに含まれていない
- [ ] 類似度スコアが適切（0.25以上が基本、低い場合は0.0まで下げる）
- [ ] 追加検索が適切に提案されている
- [ ] 検索結果が重複していない

### 分析の品質

- [ ] 推奨事項が自然な文章で書かれている
- [ ] 「テンプレート感」がない
- [ ] 具体的なチケット番号や内容が引用されている
- [ ] 注意事項が適切に抽出されている

### UIの品質

- [ ] 重要度バッジが適切（必須、重要、参考、関連）
- [ ] チケットカードが見やすい
- [ ] 展開式の詳細情報が機能する
- [ ] Redmineリンクが正しい

## 🐛 トラブルシューティング

### 問題: 検索結果が0件

**原因**:
1. Qdrantにデータがない
2. 類似度の閾値が高すぎる
3. Redmineに該当するチケットがない

**確認**:
```bash
# Qdrantのデータ確認
curl http://localhost:6333/collections/maintenance_tickets

# vectors_count を確認
```

**解決**:
```bash
# データがない場合
source venv/bin/activate
python scripts/index_redmine_tickets.py
```

### 問題: LLMが追加検索を提案しない

**原因**:
1. 初回検索で十分なチケットが見つかった
2. LLMのプロンプトが適切に機能していない

**確認**:
- API ログを確認: `tail -f logs/api.log`
- OpenAI API キーが有効か確認

### 問題: 推奨事項がテンプレート的

**原因**:
- LLMのtemperatureが低すぎる（現在0.7）
- プロンプトが不十分

**調整**:
`app/services/procedure_assistant_service.py` の `_generate_recommendations()`:
```python
temperature=0.7  # もっと高くする場合は0.8-0.9
```

### 問題: エラー "name 'Optional' is not defined"

**原因**: インポート漏れ（修正済み）

**確認**:
```bash
grep "from typing import" app/services/vector_service.py
# → from typing import List, Optional が表示されるはず
```

### 問題: Docker Compose エラー

**原因**: AlmaLinux 9 では `docker-compose` (ハイフン) が使えない

**解決**: `docker compose` (スペース) を使用（start.sh/stop.sh で修正済み）

## 📈 パフォーマンス

### 想定処理時間

- クエリ分析: 1-2秒
- 初回検索: 0.5秒
- チケット内容分析: 3-5秒
- 追加検索: 各1秒
- 統合・推奨事項生成: 3-5秒

**合計**: 約10-15秒

処理が30秒以上かかる場合:
- OpenAI API のレートリミットに達している可能性
- Qdrantの応答が遅い可能性

## 🎓 実運用での確認事項

### 運用員からのフィードバック

実際に使ってもらった後、以下を確認:

1. **検索の精度**:
   - [ ] 関連するチケットが見つかるか
   - [ ] 見つからないチケットがあるか
   - [ ] 不要なチケットが含まれていないか

2. **推奨事項の質**:
   - [ ] 手順書作成に役立つか
   - [ ] 具体的で実用的か
   - [ ] 見落としがないか

3. **使いやすさ**:
   - [ ] UIが直感的か
   - [ ] 詳細情報の展開が使いやすいか
   - [ ] Redmineへのリンクが便利か

4. **改善点**:
   - 検索精度を上げるには？
   - 表示する情報を増やす/減らす？
   - 他に必要な機能は？

## 📝 次のステップ

### フィードバック収集後

1. **検索精度の調整**:
   - `score_threshold` の調整
   - 追加検索のロジック改善

2. **UI改善**:
   - タグの追加（サーバー種別、作業種別など）
   - フィルタ機能

3. **機能追加**:
   - チケット間の関係性の可視化
   - 手順書テンプレートの自動生成（ユーザーが明示的に要求した場合のみ）

---

**重要**: このシステムは「手順書を自動生成」するのではなく、「手順書作成を補佐」するものです。運用員が自分で考え、判断することを支援するツールとして設計されています。
